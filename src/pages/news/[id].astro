---
import { getCollection, render } from 'astro:content';
import SingleColumn from '@layouts/SingleColumn.astro';
import { formatDate } from '@scripts/date';
import { SITE } from '@/config/site';

export const getStaticPaths = async () => {
  const news = await getCollection("news");
  return news.map((newsItem) => ({
    params: { id: newsItem.id },
    props: { newsItem },
  }));
};

const {
  newsItem,
  newsItem: {
    data: {
      author,
      date,
      title,
      summary,
      image,
    },
    body,
  }
} = Astro.props;

const formattedDate = formatDate(date);
const { Content } = await render(newsItem);

let description = summary;
if (!description && body) {
  const firstParagraph = body
    .split('\n\n')
    .find(p => p.trim().length > 0 && !p.trim().startsWith('#') && !p.trim().startsWith('!'));
  if (firstParagraph) {
    description = firstParagraph
      .replace(/[#*_`\[\]()]/g, '')
      .replace(/!\[.*?\]\(.*?\)/g, '')
      .trim()
      .substring(0, 160);
    if (description.length === 160) {
      description += '...';
    }
  }
}
if (!description) {
  description = `${title} - ${SITE.name}`;
}

let ogImage = image;
if (!ogImage && body) {
  const imageMatch = body.match(/!\[.*?\]\(([^)]+)\)/);
  if (imageMatch && imageMatch[1]) {
    ogImage = imageMatch[1];
  }
}

const canonical = `${SITE.url}/news/${newsItem.id}`;
---

<SingleColumn 
  metaTitle={title} 
  pageTitle={title} 
  description={description}
  image={ogImage}
  type="article"
  canonical={canonical}
>
  <strong>
    News | { formattedDate } by {author}
  </strong>
  <hr />
  <Content />
</SingleColumn>
